---
layout: post
title: "Android一些开发的小技巧"
description: "Java"
category: android开发

---

# Android 6.0权限适配

## 背景

App开发时，如果将targetSdkVersion设置为23，或者以上，当运行在Android 6.0 +的手机上时，对于一些敏感权限的获取就会采用动态请求的方式:
还可以加个requestCode参数，区分同样权限的请求，可以用到MVP开发中，放在persenter里面

        PermissionCompat.requestPermission(this, P_CAMERA, new OnGrantedListener() {

		    // 根据permissions自行处理，可合并，可分开
		    @Override
		    public void onGranted(SecondActivity target, String[] permissions) {
		        if (Arrays.equals(permissions, P_CALL)) {
		            LogUtils.v("P_CALL");
		        } else if (Arrays.equals(permissions, P_CAMERA)) {
		            LogUtils.v("P_CAMERA");
		        } else {
		            LogUtils.v("else");
		        }
		        ToastUtil.show(Arrays.toString(permissions) + " onGranted");
		    }
		
		    @Override
		    public void onDenied(SecondActivity target, String[] permissions) {
		        if (Arrays.equals(permissions, P_CALL)) {
		            LogUtils.v("P_CALL");
		        } else if (Arrays.equals(permissions, P_CAMERA)) {
		            LogUtils.v("P_CAMERA");
		        } else {
		            LogUtils.v("else");
		        }
		        ToastUtil.show(Arrays.toString(permissions) + " onDenied");
		    }
		
		    @Override
		    public void onNeverAsk(SecondActivity target, String[] permissions) {
		        if (Arrays.equals(permissions, P_CALL)) {
		            LogUtils.v("P_CALL");
		        } else if (Arrays.equals(permissions, P_CAMERA)) {
		            LogUtils.v("P_CAMERA");
		        } else {
		            LogUtils.v("else");
		        }
		        ToastUtil.show(Arrays.toString(permissions) + " onNeverAsk");
		    }
		
		    @Override
		    public void onShowRationale(SecondActivity target, String[] permissions) {
		        if (Arrays.equals(permissions, P_CALL)) {
		            LogUtils.v("P_CALL");
		        } else if (Arrays.equals(permissions, P_CAMERA)) {
		            LogUtils.v("P_CAMERA");
		        } else {
		            LogUtils.v("else");
		        }
		        ToastUtil.show(Arrays.toString(permissions) + " onShowRationale");
		    }
        });
        
        
    
### 参考Easy Permission采用最直接的回调，基类Activity设置最简单的回调监听




### PermissionDispatch ：注解，加动态编程跟回调

用法依赖apt生成的类，代码中有耦合


    @NeedsPermission(Manifest.permission.CAMERA)
    void showCamera() {
        // NOTE: Perform action that requires the permission. If this is run by PermissionsDispatcher, the permission will have been granted
        getSupportFragmentManager().beginTransaction()
                .replace(R.id.sample_content_fragment, CameraPreviewFragment.newInstance())
                .addToBackStack("camera")
                .commitAllowingStateLoss();
    }
    
    
    @OnPermissionDenied(Manifest.permission.CAMERA)
    void onCameraDenied() {
        // NOTE: Deal with a denied permission, e.g. by showing specific UI
        // or disabling certain functionality
        Toast.makeText(this, R.string.permission_camera_denied, Toast.LENGTH_SHORT).show();
    }

    @OnNeverAskAgain(Manifest.permission.CAMERA)
    void onCameraNeverAskAgain() {
        Toast.makeText(this, R.string.permission_camera_never_askagain, Toast.LENGTH_SHORT).show();
    }

    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
        // NOTE: delegate the permission handling to generated method
        MainActivityPermissionsDispatcher.onRequestPermissionsResult(this, requestCode, grantResults);
    }

    MainActivityPermissionsDispatcher.showContactsWithCheck(this);
   
   

### 自定义：基于apt与注解，实现编译过程中生成代码，并在调用时，自动添加回调

用法Activity继承BasePermissionCompatActivity，用注解写回调函数，支持权限分组，跟单独处理，但是每个分组都要写自己的回调函数（目前回调函数，不支持参数）
	
	@ActivityPermission
	public class PermssionActivity extends BasePermissionCompatActivity {
	
     	。。。
     
	    @OnGranted(value = {Manifest.permission.CAMERA})
	    void granted() {
	        LogUtils.v("granted");
	    }
	
	    @OnDenied(value = {Manifest.permission.CAMERA})
	    void onDenied() {
	        LogUtils.v("onDenied");
	    }
	
	    @OnNeverAsk(value = {Manifest.permission.CAMERA})
	    void OnNeverAsk() {
	        LogUtils.v("OnNeverAsk");
 
	    }
	
	    @OnShowRationale(value = {Manifest.permission.CAMERA})
	    void OnShowRationale() {
	        LogUtils.v("OnShowRationale");
	    }
	    
		<!--何时的时机调用-->
	    @OnClick(R.id.get)
	    void get() {
	        PermissionCompat.requestPermission(this, new String[]{Manifest.permission.CAMERA});
	    }
	}


### 优缺点对比

直接回调：简单明了，
注解：编程的时候简单，直接注解写回调，就行	


未完成：对于同样权限的回调，不同地方，对于相同权限的回调