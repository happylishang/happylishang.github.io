---
layout: post
title: "仿京东淘宝上拉加载详情View定制"
description: "View定制"
category: android开发

---

1、实现步骤 拆分+合并
2、功能需求划分
3、实现
4、实现效果

先来看一下要实现的实现的效果

<img src="https://github.com/happylishang/DragScrollDetailsLayout/blob/master/video/scrollview%2Bviewpager.gif" width=300></img> 

<img src="https://github.com/happylishang/DragScrollDetailsLayout/blob/master/video/scrollview%2Bfragmenttabhost.gif" width=300></img>

<img src="https://github.com/happylishang/DragScrollDetailsLayout/blob/master/video/scrollview%2Blistview.gif" width=300></img> 

<img src="https://github.com/happylishang/DragScrollDetailsLayout/blob/master/video/scrollview%2Bwebview.gif" width=300></img>


<iframe height=500 width=500 src="https://github.com/happylishang/DragScrollDetailsLayout/blob/master/video/scrollview%2Bviewpager.gif"/>

# 滑动速度的判定，用来决定最后的手势的处理

> VelocityTracker 注意recycle，否则内存占用太客观

用法

* 在down的时候，初始化：

          case MotionEvent.ACTION_DOWN:
                mDownMotionX = ev.getX();
                mDownMotionY = ev.getY();
                if (mVelocityTracker == null) {
                    mVelocityTracker = VelocityTracker.obtain();
                }
                mVelocityTracker.clear();
                
* move的时候add

        mVelocityTracker.addMovement(event);
        
* 在up、cancle的时候计算速度，决定滑动惯性，并回收：

判定

    private boolean needFlingToToggleView() {
        mVelocityTracker.computeCurrentVelocity(1000, mMaxFlingVelocity);
        if (mCurrentViewIndex == CurrentTargetIndex.UPSTAIRS) {
            if (-mVelocityTracker.getYVelocity() > mMiniFlingVelocity) {
                return true;
            }
        } else {
            if (mVelocityTracker.getYVelocity() > mMiniFlingVelocity) {
                return true;
            }
        }
        return false;
    }
    
回收
      
    private void recycleVelocityTracker() {
        if (mVelocityTracker != null) {
            mVelocityTracker.clear();
            mVelocityTracker.recycle();
            mVelocityTracker = null;
        }
    }

# 如何判定View自身是否可滚动--注意递归其内部child以及区分ViewPager

    /***
     * first    can view self  ScrollVertically
     * seconde  if View is ViewPager only judge current page
     * third    if view is viewgroup check it`s children
     */
    private boolean canScrollVertically(View view, int offSet) {

        if (ViewCompat.canScrollVertically(view, offSet)) {
            return true;
        }
        if (view instanceof ViewPager) {
            return canViewPagerScrollVertically((ViewPager) view, offSet);
        }
        if (view instanceof ViewGroup) {
            ViewGroup vGroup = (ViewGroup) view;
            for (int i = 0; i < vGroup.getChildCount(); i++) {
                if (canScrollVertically(vGroup.getChildAt(i), offSet))
                    return true;
            }
        }
        return false;
    }
    
    