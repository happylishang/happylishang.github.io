---

layout: post
title: "Fresco分析（一）内存管理篇"
description: "android"
category: Fresco
tags: [android]

---
 
#### 打开官方demo

ndk绝对路径放在imagepipeline的build里面更改

	def getNdkBuildFullPath() {	
	    return "/Users/personal/software/android-ndk-r10e/ndk-build" 
 
问题：
 
#### 图片不用bitmap的时候，如何管理Bitmap引用 如何从inuse变成evikable

Fresco的 DraweeView在onDetacheWindow或者重新绘制View的时候，会 dropCaches()，就好像主动释放内存，其实是减小引用。

	  @Override
	  public synchronized void dropCaches() {
	    mBitmapsToKeepCached.setAll(false);
	    dropBitmapsThatShouldNotBeCached();
	    for (Bitmap freeBitmap : mFreeBitmaps) {
	      freeBitmap.recycle();
	      sTotalBitmaps.decrementAndGet();
	    }
	    mFreeBitmaps.clear();
	    mAnimatedDrawableBackend.dropCaches();
	    FLog.v(TAG, "Total bitmaps: %d", sTotalBitmaps.get());
	  }
  

	  private synchronized void dropBitmapsThatShouldNotBeCached() {
	    int index = 0;
	    while (index < mCachedBitmaps.size()) {
	      int frameNumber = mCachedBitmaps.keyAt(index);
	      boolean keepCached = mBitmapsToKeepCached.get(frameNumber);
	      if (!keepCached) {
	        CloseableReference<Bitmap> bitmapReference = mCachedBitmaps.valueAt(index);
	        mCachedBitmaps.removeAt(index);
	        bitmapReference.close();
	      } else {
	        index++;
	      }
	    }
	  }
	  
	  @Override
	  public void close() {
	    synchronized (this) {
	      if (mIsClosed) {
	        return;
	      }
	      mIsClosed = true;
	    }
	
	    mSharedReference.deleteReference();
	  }

#### 内存的分配策略是怎么样

#### 引用机制