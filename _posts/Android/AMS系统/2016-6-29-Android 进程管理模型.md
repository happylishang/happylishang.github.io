---
layout: post
title: "Android 进程管理模型"
description: "Java"
category: Android

---

#### 前言

Android基于Linux内核，其进程管理模型沿用Linux进程模型，但是由于Goodle为了方便App开发，将进程进行了了封装，应用层几乎看不到进程的概念，开发者接触到的只是组件的概念。

* 当按下Android设备电源键时究竟发生了什么？
* Android的启动过程是怎么样的？
* 什么是Linux内核？
* 桌面系统linux内核与Android系统linux内核有什么区别？
* 什么是引导装载程序？
* 什么是Zygote？
* 什么是X86以及ARM linux？
* 什么是init.rc?
* 什么是系统服务？

#### Android系统的启动

当内核完成系统设置，它首先在系统文件中寻找”init”文件，然后启动root进程或者系统的第一个进程，init是第一个进程，可以说它是root进程或者说有进程的父进程会启动第一个用户级别的 init进程是Linux内核启动的第一个用户级进程，

<img src="http://jbcdn2.b0.upaiyun.com/2014/06/e516252bdb5ae1c1798ec9507a060f19.png"/ width=600>

#### Android进程类型

* init进程
* init.rc中的Service进程
* zygote进程及守护进程rild、ServiceManager进程等
* SystemServer及其他系统服务
* Android Application进程

#### init进程

当内核完成系统设置，它首先在系统文件中寻找”init”文件，然后启动root进程或者系统的第一个进程，init是第一个进程，可以说它是root进程或者说有进程的父进程会启动第一个用户级别的 init进程是Linux内核启动的第一个用户级进程。init进程是linux系统中用户空间的第一个进程，进程号为1，有两个责任，一是挂载目录，比如/sys、/dev、/proc，二是运行init.rc脚本。

#### Zygote加载进程及守护进程rild、ServiceManager进程等

##### Zygote进程  service zygote /system/bin/app_process -Xzygote /system/bin --zygote 

	registerZygoteSocket();//登记Listen端口  
	startSystemServer();//启动SystemServer  

在Java中，我们知道不同的虚拟机实例会为不同的应用分配不同的内存。假如Android应用应该尽可能快地启动，但如果Android系统为每一个应用启动不同的Dalvik虚拟机实例，就会消耗大量的内存以及时间。因此，为了克服这个问题，Android系统创造了”Zygote”。Zygote让Dalvik虚拟机共享代码、低内存占用以及最小的启动时间成为可能。Zygote是一个虚拟器进程，正如我们在前一个步骤所说的在系统引导的时候启动。Zygote预加载以及初始化核心库类。通常，这些核心类一般是只读的，也是Android SDK或者核心框架的一部分。在Java虚拟机中，每一个实例都有它自己的核心库类文件和堆对象的拷贝。

* 加载ZygoteInit类，源代码：/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java
* registerZygoteSocket()为zygote命令连接注册一个服务器套接字。
* preloadClassed “preloaded-classes”是一个简单的包含一系列需要预加载类的文本文件，你可以在<Android Source>/frameworks/base找到“preloaded-classes”文件。
* preloadResources() preloadResources也意味着本地主题、布局以及android.R文件中包含的所有东西都会用这个方法加载，在这个阶段，你可以看到启动动画。

##### ServiceManager守护类进程 

#### 系统服务或服务

完成了Zygote进程后，运行环境请求Zygote运行系统服务。系统服务同时使用native以及java编写，系统服务可以认为是一个进程。同一个系统服务在Android SDK可以以System Services形式获得。系统服务包含了所有的System Services。

Zygote创建新的进程去启动系统服务。你可以在ZygoteInit类的”startSystemServer”方法中找到源代码。

核心服务：

* 启动电源管理器；
* 创建Activity管理器；
* 启动电话注册；
* 启动包管理器；
* 设置Activity管理服务为系统进程；
* 启动上下文管理器；
* 启动系统Context Providers；
* 启动电池服务；
* 启动定时管理器；
* 启动传感服务；
* 启动窗口管理器；
* 启动蓝牙服务；
* 启动挂载服务。
* 其他服务：

* 启动状态栏服务；
* 启动硬件服务；
* 启动网络状态服务；
* 启动网络连接服务；
* 启动通知管理器；
* 启动设备存储监视服务；
* 启动定位管理器；
* 启动搜索服务；
* 启动剪切板服务；
* 启动登记服务；
* 启动壁纸服务；
* 启动音频服务；
* 启动耳机监听；
* 启动AdbSettingsObserver（处理adb命令）。

#### 参考文档

[Inside the Linux boot process](http://www.ibm.com/developerworks/linux/library/l-linuxboot/)       
[Android启动过程深入解析](http://blog.jobbole.com/67931/)