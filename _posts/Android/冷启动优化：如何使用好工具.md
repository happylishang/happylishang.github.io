APP的性能提升无非就是围绕稳定、流畅之类的指标做文章，在推动性能提升的时候，什么才是关键，热情？能力 ？规范？，个人认为是工具，用好性能分析工具，性能提升就走完了一大半，就好比：”算数我比不过小王，但我找了个电子计算器“。以提升冷启动速度为例，看看性能工具能带来什么。

# 如何衡量当前的性能

性能衡量分三步：  **指标制->  指标采集 -> 性能基线**,以上三块组成性能量化工具，有了量化工具，边可以说APP性能是好是坏，以冷启动为例，其指标可定义如下：

	冷启动耗时=从APP进程创建到第一个有效页面帧

如何采集？无论线上还是线下都是打点，基线呢？可以参考业界做法，

	优秀=秒开 

聚合后，如果发现不达标，那接下来要做的就是定位+优化，这个时候最终要的就是工具。

# 如何定位当前性能问题

同样以冷启动为例，如何选择及使用工具，冷启动可以用的有Debug.startMethodTracing，跟踪，也可以利用perfetto/systrace来查看，先看Debug.startMethodTracing


## Debug.startMethodTracing 适合查看UI线程

用法：进程启动开启函数耗时监听，并在合适节点配对停止，之后导出.trace文件分析即可。

    private void startTrace() {
        File file = new File(getApplication().getExternalFilesDir("android"), "methods.trace");
        Debug.startMethodTracing(file.getAbsolutePath(), 100 * 1024 * 1024);
    }
	<!-注意配对使用-->
    private void stopTrace() {
        Debug.stopMethodTracing();
    }

.trace文件导入Studio之后，就可以查看关键函数耗时，以冷启动为例，可以分几个阶段排查，进程创建及Application初始化阶段，选定Main线程，然后将范围限制定Application阶段。Studio提供了多种模式，Flame Chart、Top Down、Bottom Up、Event，不同的模式侧重点不同。

*  Flame Chart更侧重：直观反映函数耗时的严重程度

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96cf09d30b924f6bac2963e147f01e33~tplv-k3u1fbpfcp-watermark.image?)

比如上图，浅黄色部分其实就是需要重点关注的部分,耗时最严重的函数，会最先展示，更加方便定位严重问题。


* Top Down 更侧重：自顶向下**排查**

利用Top-Down模式可以更精确观察函数耗时与调用堆栈，更加清晰，如下在Application初始化阶段，很容易看到那些函数被调用、顺序、耗时等，

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/138af79c4866421185ceb3e3faca94ce~tplv-k3u1fbpfcp-watermark.image?)

之后，重点排查，将非核心逻辑从UI线程中移除。同理对于闪屏Activity的onCreate跟onResume阶段：


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/349265d2bc8f4fab9ee373f6284bc476~tplv-k3u1fbpfcp-watermark.image?)

很容下发现，有些Flutterboost、埋点Json解析类的耗时操作被不小心关联进了Activit的launcher中，拖慢了冷启动速度，同样考虑放到非UI线程去处理，或者用其他方式避免。

* Bottom Up：一种平铺的模式，

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f88d69ac118542a592a77a9089dd1a98~tplv-k3u1fbpfcp-watermark.image?)

这个模式个人用的不多，罗列的函数太多，没有层次，可能单独看排名靠前的几个有些收益，基本上依赖profiler就能定位哪些函数导致了冷启动速度慢，但是这些函数可能并非自己耗时，也许是会因为调度或者锁的原因导致慢，这个时候perfetto/systrace会提供更多帮助。

# perfetto/systrace

[perfetto地址及使用文档](https://ui.perfetto.dev/#!/record)


perfetto/systrace官方提供另一种性能采集工具，其中perfetto可以看做是systrace的升级版。相比MethodTracing代码插桩，无法具体到每个方法，但可以提供全局性能概览，但是可以更快定位问题范围，而且perfetto/systrace在全局任务调度、系统调用上更具优势，而MethodTracing更侧重函数耗时，尤其是UI线程函数，最后，MethodTracing多少对于性能有些影响，而perfetto/systrace借助系统本身lOG，影响更低。

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c673d7fc05fb4c92afadcb1151abe50e~tplv-k3u1fbpfcp-watermark.image?)

如上图所示：UI线程之前没有获取锁进入了睡眠，之后，另一个线程释放了锁唤起了UI线程，这种问题一般是编码时，没详细考虑线程同步问题导致的，定向修改即可。再比如，看下图中蓝色部分，发现资源解析优势比较耗时的部分：

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d28fef2e1cb540d18cee218594206041~tplv-k3u1fbpfcp-watermark.image?)

	Name	res/BKC.xml
	Category	null
	Start time	1s 309ms 568us 459ns
	Duration	42ms 35us 682ns
	Slice ID	2465

可以适当将图缩小，降低加载成本，经过优化，资源解析缩短到8ms

	Name	res/BKC.xml
	Category	null
	Start time	964ms 602us 749ns
	Duration	8ms 260us 261ns
	Slice ID	11851
	type	internal_slice
 
还有些牵扯过早注册Receiver、那部分逻辑比较耗时都能看到个大概。 

# 优化效果对比：用perfetto看比较直接

优化前：1261ms

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8cefd5ea2a124bd6a1b72ed8629a7b5f~tplv-k3u1fbpfcp-watermark.image?)

 
优化后：439ms

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75861e508f7843f097599a35656612ee~tplv-k3u1fbpfcp-watermark.image?)


## 利用Studio自身Profiler监测冷启动 :不推荐，

这种对于性能影响较大，不易提现问题，不信可自行尝试 

1. 	依次选择 Run > Edit Configurations。
1. 	在 Profiling 标签中，勾选 Start recording a method trace on startup 旁边的复选框。
1. 	从菜单中选择 CPU 记录配置。
1. 	点击 Apply。
1. 	依次选择 Run > Profile，将应用部署到搭载 Android 8.0（API 级别 26）或更高版本的设备。

不过你可能会发现，很多函数的执行事件都被拉长了，对于定位问题反而不利。
