# 可信ID优化

## 首次未联网优化

之前的实现有个漏洞，如果用户一开始断网，那么第一次请求可信ID是失败的，并且模拟器信息上报也是失败的，这样可能导致用户首次下单的时候没有可信ID，也没有模拟器信息，因此在网络状态变化的时候需要加个监听，如果可信ID还没有获取，需要主动获取可信ID，并及时回传模拟器信息。

## 对于内存Cache检测模型的优化：只有超过一定次数，才启用该字段


内存Cache检测是模拟器检测手段之一（最后面的手段，如果通过安全的手段能够检测，不会用该手段），由于内存检测是根据指令ARM Cache同步不及时原理来做的，虽然概率低，但是由于Android处理器型号众多，ROM复杂多样，仍有可能出现误判。

>问题：线上碰到一个用户，刚好在一个风控的节点，被Cache模型检测为模拟器。

按照当前后台的统计统计，只有极低的概率出现误检测，因此，为了提高准确性，尤其是首次，APP端在启动后应多检测几次，并上报，打开APP后，直接检测10次（用户无感知，即时后台Crash），对于模拟器，检测结果应该几乎全为模拟器，而真机，也应该几乎全为真机。对于内存Cache检测字段，可以用10作为一个下限，想要判定一个设备为模拟器，必须至少有10次被检测为模拟器，并且检测为模拟器的概率必须超过一定比例，该手段才将其判断为模拟器。

![Arm Cache不同步原理.jpg](http://upload-images.jianshu.io/upload_images/1460468-30be15757c6ef007.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 基于统计数据对检测模型的优化：原则--宁放过，不误杀

目前可信ID平台判断模拟器的标准是依赖最后一次上报，这样做有很大局限性，目前，基于内存Cache模型的检测只能保证相对准确，无法做到100%，即时对于同一个设备也有可能出现一定概率的误判（目前来看概率很低），如果仅仅依靠一次的判断，则会有一定的风险，同时对于原有统计的模拟器数据也是一种浪费。比如，对于同一个trustid的设备，已经判断了1000次模拟器属性，如果990次判断为真机，而仅仅10次判断为模拟器，则可以将设备判断为真机，后面就不需要再次判断及更新该设备属性，可以安全的认定是真机，这样做也能将之前的统计数据利用起来，或者说，后台不断地更新模拟器判断统计比例，按比例划分：

![统计](http://upload-images.jianshu.io/upload_images/1460468-3becd0720da04563.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

对于内存Cache模型的检测结果，只有检测次数大于10次、P>80%，且最后一次检测结果是模拟器的时候，才看做是模拟器，否则本次看做真机。

* 机器是模拟 = 被检测为模拟器的次数超过10次 + 被检测为模拟器的概率超过80% + 最后一次检测的结果是模拟器
* 持久化为真机 = 被检测次数超过1000次 + 被检测为真机的概率超过80% （甄别一个设备是安全设备，后续就信任了）

## 可信ID生成优化

有些设备MAC地址匹配上，并且出口IP一致，虽然序列号匹配不上，但是可疑程度很高，当序列号等匹配不上，MAC、IP、设备类型能匹配上，是否也看成同一设备。


300万  3700  2000 IP相同