---
layout: default
title: OOM内存溢 
categories: [android,OOM]

---

### OOM内存溢

### 索引

* 什么时候回内存溢出
* 为何会内存溢出
* 如何避免内存溢出

#### OOM内存溢出概述

Android系统的Dalvik虚拟机扮演了常规的内存垃圾自动回收的角色，Android系统没有为内存提供交换区，它使用 paging与 memory-mapping(mmapping)的机制来管理内存。通过不同的内存分配方式（malloc/mmap/JNIEnv/etc）对不同的对象（Bitmap/etc）进行操作，会因为Android系统版本的差异而产生不同的行为，对Native Heap与Dalvik Heap以及OOM的判断条件都会有所影响。在2.x的系统上，我们常常可以看到Heap Size的total值，明显超过了通过getMemoryClass()获取到的阈值而不会发生OOM的情况。那么，针对2.x与4.x的Android系统，到底如何判断会发生OOM呢？

Android 2.x系统GC LOG中的dalvik allocated + external allocated + 新分配的大小 >= getMemoryClass()值的时候就会发生OOM。 例如，假设有这么一段Dalvik输出的GC LOG：GC_FOR_MALLOC free 2K, 13% free 32586K/37455K, external 8989K/10356K, paused 20ms，那么32586+8989+(新分配23975)=65550>64M时，就会发生OOM。

Android 4.x的系统废除了external的计数器，类似Bitmap的分配改到Dalvik的Java Heap中申请。只要allocated + 新分配的内存 >= getMemoryClass()的时候就会发生OOM，如图7所示（注：虽然图示演示的是ART运行环境，但是统计规则还是和Dalvik保持一致）。

### 参考文档

Android内存优化之OOM <http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0920/3478.html>