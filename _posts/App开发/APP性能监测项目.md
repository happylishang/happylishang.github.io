## 背景

关键性能指标是衡量APP质量必不可少的一环，目前严选线上性能指标值采集了Crash及网络，像帧率、APP启动、界面启动、内存、内存泄露等指标均缺乏，而且不同手机的表现相差也挺大，尤其对于Android，线上有几百种机型在跑，这部分指标的完善很重要。

其次，目前缺少一套基线，即：什么样的页面是符合性能要求，这个衡量的基本标准目前缺失，咨询了下云音乐，他们目前也没有线上性能监测能力，只是本地跑跑数据，目前业内给出的开源项目，大部分都是离线下本地数据采集，线上生产环境能直接跑的轻量级监测SDK还没有，所以这部分能力需要我们自己补全。


## 方案对比选择


   sdk名称      |  现状          | 能否直接线上用     |
--------------------|------------------|-----------------------|
腾讯matrix       | 太重且不稳定      | 否   |
腾讯GT       | 3年没更新，适合线下跑跑  |否   |
网易Emmagee  | 3年多没更，基本废弃  |否        |
听云App    |  适合监测网络跟启动，场景受限  | 否   |
DoraemonKit哆啦A梦         | 功能强大，定位是本地看性能，需要剥离   | 否 |
360 ArgusAPM         |  没来及看     |  没来及看|
自研       |   保持轻量级，支持自定义，安全     |  是|


## 核心性能指标

* 网络状况（APM已经实现）
* 崩溃（Crash Firebase （Android端分析有点问题））
*  冷启动时间及各个页面启动时间
* 页面刷新帧率、卡顿（FPS、及瞬时帧率）、ANR
* 内存使用及内存泄露 
* 流量消耗（Flow）
*  电量
*  CPU使用率（CPU） ：还不知道有什么用

## 基线的制定（参考业界或者先线上跑跑）

### FPS基线(每秒传输帧数Frames Per Second）

从腾讯、百度各方的报告来看，用FPS来衡量是否卡顿并不科学，理想情况下FPS是60，在硬件没有特殊订制的情况，上限也是60，每16ms都能完成一帧的刷新，达到60肯定是不卡的，但是50的帧率卡顿吗？答案是不一定。平时看到的大部分电影或视频 FPS并不高，30FPS即可满足，一个稳定在 30FPS 的动画，并不卡顿，但如果FPS 很不稳定，却更容易感知到，这里有个词叫**稳定**，50的FPS如果是均分到各个节点，那么用户是感知不到掉帧的，但是，如果剩余的10帧是一次回执掉的，那用户的感知就很明显，也就是**瞬时帧率**的意义更大。

> 掉帧/跳帧/卡顿

理想帧率 60FPS 的情况下，每一帧 16.6667ms，如果一帧准备超出这个值，则认为发生掉帧，超出的时间越长，掉帧程度越严重。假设每帧准备时间约 32ms，每次只掉一帧，那么 1 秒内实际只刷新 30 帧，即平均帧率只有 30FPS，但这时往往不会觉得是卡顿。反而如果出现某次严重掉帧（>300ms），那么这一次的变化，通常很容易感知到。所以界面的掉帧程度，往往可以更直观的反映出卡顿。Matrix给的卡顿建议

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e52ff90fe76495fa656d02e96a123fc~tplv-k3u1fbpfcp-zoom-1.image)

相比单看平均帧率，掉帧程度的分布更能反应界面流畅程度。百度的流畅定义跟Martrix类似，区分了小卡顿与大卡顿，同样认为**瞬时大卡顿**是造成界面流畅度降低的核心原因。

ANR：可以看做更加严重的卡顿，处于Frozen状态，先暂时定义5S内无响应，后者UI线程单个任务没处理完

结论：瞬时帧率能真实反应界面流畅度，一般瞬时帧率平局小于3的情况下，都可以认为界面流畅。

### 界面启动基线

* 冷启动耗时：从APP加载到看到第一个（Splash）界面内容（注：不是展示默认背景）
* 单个界面启动耗时：从上个界面挂起到下一个界面第一帧可见（数据可能还未填充）

### 内存基线

内存是使用基线目前并没有找到非常合适的指标，这里只做两点

* **内存泄露**：零内存泄露最理想，理论上也是可以做到 
* 内存使用占比：不同配置不同，需要线上跑跑看，拿Android为例，不同系统、不同配置内存分配策略都有差异，需要分别看

### 流量消耗 、电量、CPU使用

这三个指标还没想好怎么用，采集了有多大意义

## 实现方案

* Android端
* ios

## 推进计划

* 准备9月中上线，不许要QA参与

## 上线及后续使用跟进

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b01b4a50ad3143c1bdaa75eef89ad951~tplv-k3u1fbpfcp-zoom-1.image)


 
 
 
